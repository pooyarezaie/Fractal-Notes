<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">

    {%- seo -%}
    {%- if page.sitemap == false or page.robots -%}
    <meta name="robots" content="{{ page.robots | default: 'noindex, nofollow' }}">
    {%- endif -%}

    {%- assign page_url_abs = site.url | append: page.url -%}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "BreadcrumbList",
          "itemListElement": [
            { "@type": "ListItem", "position": 1, "name": "{{ site.title | escape }}", "item": "{{ site.url }}/" }
            {%- if page.url != '/' and page.url != '' -%}
            ,{ "@type": "ListItem", "position": 2, "name": "{{ page.title | default: page.name | escape }}", "item": "{{ page_url_abs }}" }
            {%- endif -%}
          ]
        }
        {%- if page.url != '/' and page.url != '' and page.title -%}
        ,{
          "@type": "Article",
          "headline": {{ page.title | jsonify }},
          "description": {{ page.description | default: site.description | jsonify }},
          "url": "{{ page_url_abs }}",
          "author": { "@type": "Person", "name": {{ site.author | jsonify }} },
          "publisher": { "@type": "Organization", "name": {{ site.title | jsonify }}, "logo": { "@type": "ImageObject", "url": "{{ site.url }}{{ site.logo }}" } }
        }
        {%- endif -%}
      ]
    }
    </script>

    <!-- Preload main font for faster first paint; SW caches it for repeat visits -->
    <link rel="preload" href="{{ '/assets/fonts/Vazirmatn-wght.woff2' | relative_url }}" as="font" type="font/woff2" crossorigin>

    <link rel="stylesheet" href="{{ "/assets/css/style.css" | relative_url }}">

    <link rel="icon" href="/favicon.ico">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" href="/favicon-48x48.png" type="image/png" sizes="48x48">
    <link rel="icon" href="/favicon-96x96.png" type="image/png" sizes="96x96">

    <link rel="alternate icon" type="image/png" href="{{ "/assets/img/logo.png" | relative_url }}">
    <link rel="shortcut icon" href="{{ "/assets/img/logo.png" | relative_url }}">
    
    <meta name="apple-mobile-web-app-title" content="یادداشت‌های فرکتالی">

    <!-- KaTeX 0.16.9 – self-hosted (MIT, https://katex.org) -->
    <link rel="stylesheet" href="{{ '/assets/katex/katex.min.css' | relative_url }}">
    <script defer src="{{ '/assets/katex/katex.min.js' | relative_url }}"></script>
    <script defer src="{{ '/assets/katex/auto-render.min.js' | relative_url }}"
            onload="renderMathInElement(document.body, { delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}, {left: '\\[', right: '\\]', display: true}, {left: '\\(', right: '\\)', display: false}] }); if (window.initScrollAndWrap) window.initScrollAndWrap();"></script>
    <script>
      (function() {
        function wrapScrollable(el, className) {
          if (el.closest('.scroll-wrapper')) return;
          var wrapper = document.createElement('div');
          wrapper.className = className || 'scroll-wrapper';
          el.parentNode.insertBefore(wrapper, el);
          wrapper.appendChild(el);
        }
        function wrapTables() {
          var main = document.querySelector('main');
          if (!main) return;
          var mainWidth = main.getBoundingClientRect().width;
          main.querySelectorAll('table').forEach(function(el) {
            if (el.scrollWidth > mainWidth) wrapScrollable(el, 'scroll-wrapper');
          });
        }
        function scrollMathToStart() {
          document.querySelectorAll('.katex-display').forEach(function(el) {
            if (el.scrollWidth > el.clientWidth) el.scrollLeft = 0;
          });
        }
        function init() {
          wrapTables();
          scrollMathToStart();
          setTimeout(scrollMathToStart, 300);
          setTimeout(scrollMathToStart, 1200);
        }
        window.initScrollAndWrap = init;
      })();
    </script>
  </head>

  <body>
    <header class="site-header">
      <div class="site-header-inner">
        <button type="button" class="nav-toggle" id="nav-toggle" aria-label="باز کردن فهرست مطالب" aria-expanded="false" aria-controls="side-nav">
          <span class="nav-toggle-icon"></span>
        </button>
        <div class="site-brand">
          <a href="{{ "/" | relative_url }}" class="site-logo-link" aria-label="یادداشت‌های فرکتالی - صفحهٔ اصلی">
            <img src="{{ "/assets/img/logo.png" | relative_url }}" alt="یادداشت‌های فرکتالی" class="site-logo">
          </a>
          <div class="site-title-group">
            <a href="{{ "/" | relative_url }}" class="site-title">یادداشت‌های فرکتالی</a>
            <div class="site-subtitle">گام‌های کوچک در دل ساختارهای بزرگ ریاضی</div>
          </div>
        </div>
      </div>
    </header>

    <div class="site-body">
      <aside class="side-nav" id="side-nav" aria-label="فهرست مطالب">
        <button type="button" class="side-nav-close" id="side-nav-close" aria-label="بستن فهرست">×</button>
        <nav class="side-nav-inner">
          <span class="side-nav-title">برگه‌ها</span>
          <ul class="side-nav-list">
            {% for item in site.data.site_index %}
            <li><a href="{{ item.path | relative_url }}"{% if page.url contains item.path %} class="active"{% endif %}>{{ item.title }}</a></li>
            {% endfor %}
          </ul>
        </nav>
      </aside>
      <div class="side-nav-overlay" id="side-nav-overlay" aria-hidden="true"></div>
      <main class="container">
        {%- if page.url != '/' and page.url != '' and page.title -%}
        <article itemscope itemtype="https://schema.org/Article">
          {{ content }}
        </article>
        {%- else -%}
        {{ content }}
        {%- endif -%}
      </main>
    </div>

    <footer class="site-footer">
      <div class="site-footer-inner">
        <span class="site-footer-label">شبکه‌های اجتماعی:</span>
        <a href="https://t.me/FractalNotes" class="social-link" target="_blank" rel="noopener">
          کانال تلگرام «Fractal Notes»
        </a>
        <a href="https://x.com/FractalNotes" class="social-link" target="_blank" rel="noopener">
          صفحهٔ X (توییتر) «Fractal Notes»
        </a>
      </div>
    </footer>

    <script>
      (function() {
        var activeOverlay = null;

        function closeOverlay() {
          if (!activeOverlay) return;
          activeOverlay.remove();
          activeOverlay = null;
        }

        function openOverlay(src, alt) {
          closeOverlay();

          var backdrop = document.createElement('div');
          backdrop.className = 'image-lightbox-backdrop';

          var img = document.createElement('img');
          img.className = 'image-lightbox-img';
          img.src = src;
          img.alt = alt || '';

          backdrop.appendChild(img);
          document.body.appendChild(backdrop);
          activeOverlay = backdrop;

          backdrop.addEventListener('click', function() {
            closeOverlay();
          });
        }

        document.addEventListener('click', function(event) {
          if (!event.target) return;
          var target = event.target;
          if (target.tagName === 'IMG' && target.closest('main')) {
            event.preventDefault();
            openOverlay(target.currentSrc || target.src, target.alt);
          }
        });

        document.addEventListener('keydown', function(event) {
          if (event.key === 'Escape' || event.key === 'Esc') {
            closeOverlay();
          }
        });
      })();

      (function() {
        var toggle = document.getElementById('nav-toggle');
        var sideNav = document.getElementById('side-nav');
        var closeBtn = document.getElementById('side-nav-close');
        var overlay = document.getElementById('side-nav-overlay');

        function openNav() {
          if (!sideNav) return;
          sideNav.classList.add('side-nav-open');
          if (overlay) overlay.setAttribute('aria-hidden', 'false');
          if (toggle) toggle.setAttribute('aria-expanded', 'true');
          document.body.classList.add('side-nav-active');
        }

        function closeNav() {
          if (!sideNav) return;
          sideNav.classList.remove('side-nav-open');
          if (overlay) overlay.setAttribute('aria-hidden', 'true');
          if (toggle) toggle.setAttribute('aria-expanded', 'false');
          document.body.classList.remove('side-nav-active');
        }

        if (toggle) toggle.addEventListener('click', openNav);
        if (closeBtn) closeBtn.addEventListener('click', closeNav);
        if (overlay) overlay.addEventListener('click', closeNav);
      })();

      (function() {
        if (!('serviceWorker' in navigator) || location.protocol !== 'https:' && location.hostname !== 'localhost') return;
        navigator.serviceWorker.register('{{ "/sw.js" | relative_url }}', { scope: '{{ "/" | relative_url }}' }).catch(function() {});
      })();
    </script>
  </body>
</html>
